name: Java CI/CD with Maven

on:
  push:
    branches: [ "main" ]

jobs:
  build_and_release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Get Project Info
        id: get_project_info
        run: |
          # 获取 Maven 版本号
          PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          FAT_JAR_NAME="winefox-bot.jar"
          # 使用版本号命名 Jar
          RELEASE_ASSET_NAME="winefox-bot-${PROJECT_VERSION}.jar"
          
          echo "project_version=${PROJECT_VERSION}" >> $GITHUB_OUTPUT
          echo "fat_jar_name=${FAT_JAR_NAME}" >> $GITHUB_OUTPUT
          echo "release_asset_name=${RELEASE_ASSET_NAME}" >> $GITHUB_OUTPUT

      - name: Build JAR with Maven
        run: mvn -B package spring-boot:repackage --file pom.xml -s .mvn/settings.xml

      - name: Rename JAR and Zip Libs
        run: |
          mv "target/${{ steps.get_project_info.outputs.fat_jar_name }}" "target/${{ steps.get_project_info.outputs.release_asset_name }}"
          cd target
          if [ -d "lib" ]; then
             zip -r lib.zip lib/
          fi
          cd ..

      # 【已删除】Force delete and recreate 'latest' tag (不再需要)

      # 【核心修改】创建 Release
      # 使用 v + Maven版本号作为 tag
      # 使用 Commit Message 作为 body
      - name: Create Release and Upload Initial Asset
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          # 例如: v1.0.0
          tag_name: v${{ steps.get_project_info.outputs.project_version }}
          make_latest: true
          # 使用本次 Commit 的信息作为发布日志
          body: |
            ${{ github.event.head_commit.message }}
            
            Build: ${{ github.sha }}
          files: |
            target/${{ steps.get_project_info.outputs.release_asset_name }}
            target/lib.zip

      - name: Generate final release-info.properties
        id: generate_properties
        run: |
          ASSETS_JSON='${{ steps.create_release.outputs.assets }}'
          JAR_NAME="${{ steps.get_project_info.outputs.release_asset_name }}"
          LIB_NAME="lib.zip"
          RELEASE_ID='${{ steps.create_release.outputs.id }}'
          # 获取当前的 Tag Name
          TAG_NAME="v${{ steps.get_project_info.outputs.project_version }}"
          
          ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$JAR_NAME" -r '.[] | select(.name == $name) | .id')
          
          LIB_ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$LIB_NAME" -r '.[] | select(.name == $name) | .id')
          if [ -d "target/lib" ]; then
             LIB_SHA256=$(find target/lib -type f -name "*.jar" -exec sha256sum {} + | sort | sha256sum | awk '{print $1}')
          else
             LIB_SHA256=""
          fi
          echo "Calculated Content-Based Lib SHA256: $LIB_SHA256"
          
          if [ -z "$RELEASE_ID" ] || [ -z "$ASSET_ID" ] || [ "$ASSET_ID" == "null" ]; then
            echo "Error: Could not determine Release ID or Asset ID."
            exit 1
          fi

          PROPERTIES_FILE="release-info.properties"
          echo "github.release.id=$RELEASE_ID" > $PROPERTIES_FILE
          # 【新增】写入 Tag Name
          echo "github.release.tag_name=$TAG_NAME" >> $PROPERTIES_FILE
          echo "github.asset.id=$ASSET_ID" >> $PROPERTIES_FILE
          
          if [ ! -z "$LIB_ASSET_ID" ] && [ "$LIB_ASSET_ID" != "null" ]; then
             echo "github.lib.asset.id=$LIB_ASSET_ID" >> $PROPERTIES_FILE
             echo "github.lib.sha256=$LIB_SHA256" >> $PROPERTIES_FILE
          fi
          
          echo "Generated final properties:"
          cat $PROPERTIES_FILE

      - name: Inject properties into JAR
        run: |
          JAR_PATH="target/${{ steps.get_project_info.outputs.release_asset_name }}"
          jar uf "$JAR_PATH" -C . "release-info.properties"
          echo "Injected final release-info.properties into $JAR_PATH"

      # 上传注入后的 JAR (使用 tag_name 指定上传目标)
      - name: Overwrite Release Asset with final JAR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload v${{ steps.get_project_info.outputs.project_version }} "target/${{ steps.get_project_info.outputs.release_asset_name }}" --clobber
