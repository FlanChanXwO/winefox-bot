name: Java CI/CD with Maven

on:
  push:
    branches: [ "main" ]

jobs:
  build_and_release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Get Project Version and JAR Name
        id: get_project_info
        run: |
          # 从 pom.xml 中提取版本号
          PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # 拼接出最终的 JAR 文件名
          JAR_NAME="winefox-bot-${PROJECT_VERSION}.jar"
          echo "project_version=${PROJECT_VERSION}" >> $GITHUB_OUTPUT
          echo "jar_name=${JAR_NAME}" >> $GITHUB_OUTPUT
          echo "Project Version: ${PROJECT_VERSION}"
          echo "Expected JAR Name: ${JAR_NAME}"

      - name: Delete old JAR assets from Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Searching for old .jar assets in 'latest' release to delete them..."
          OLD_JARS=$(gh release view latest --json assets --jq '.assets[] | select(.name | endswith(".jar")) | .name' 2>/dev/null || echo "")
          if [ -n "$OLD_JARS" ]; then
            echo "Found old JARs to delete:"
            echo "$OLD_JARS"
            echo "$OLD_JARS" | xargs -I {} gh release delete-asset latest "{}" --yes
            echo "Successfully deleted old JAR assets."
          else
            echo "No old .jar assets found to delete."
          fi

      - name: Create/Update Release to get ID
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          body: "Latest development build, updated at ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"

      - name: Generate and place release-info.properties
        run: |
          RELEASE_ID='${{ steps.create_release.outputs.id }}'
          if [ -z "$RELEASE_ID" ]; then
            echo "Error: Could not determine Release ID."
            exit 1
          fi

          echo "Release ID is: $RELEASE_ID"
          echo "Using temporary Asset ID: -1"
          
          # 直接在 target/classes 目录创建文件，这是Maven打包的标准资源路径
          mkdir -p target/classes
          PROPERTIES_FILE="target/classes/release-info.properties"
          echo "github.release.id=$RELEASE_ID" > $PROPERTIES_FILE
          echo "github.asset.id=-1" >> $PROPERTIES_FILE
          
          echo "Generated $PROPERTIES_FILE content:"
          cat $PROPERTIES_FILE

      - name: Build 'fat' JAR with Maven
        run: mvn -B package spring-boot:repackage --file pom.xml

      - name: List target directory contents
        run: |
          echo "--- Contents of target directory ---"
          ls -lh target

      - name: Upload final 'fat' JAR to Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          JAR_PATH="target/${{ steps.get_project_info.outputs.jar_name }}"
          echo "Uploading final JAR from path: $JAR_PATH"
          gh release upload latest "$JAR_PATH" --clobber
