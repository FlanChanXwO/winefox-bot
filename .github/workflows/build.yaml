name: Java CI/CD with Maven

on:
  push:
    branches: [ "main" ]
    paths:
      - 'pom.xml' # 只有 pom.xml 变动时才尝试检查

jobs:
  build_and_release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Get Project Info
        id: get_project_info
        run: |
          PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          FAT_JAR_NAME="winefox-bot.jar"
          RELEASE_ASSET_NAME="winefox-bot-${PROJECT_VERSION}.jar"
          
          echo "project_version=${PROJECT_VERSION}" >> $GITHUB_OUTPUT
          echo "fat_jar_name=${FAT_JAR_NAME}" >> $GITHUB_OUTPUT
          echo "release_asset_name=${RELEASE_ASSET_NAME}" >> $GITHUB_OUTPUT

      - name: Download and Integrate Latest WebUI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "⬇️ Fetching latest WebUI..."
          gh release download --repo FlanChanXwo/winefox-bot-webui --pattern "*-static.zip" --output webui.zip --clobber
          mkdir -p src/main/resources/static
          unzip -o webui.zip -d src/main/resources/static
          rm webui.zip
          ls -F src/main/resources/static/

      # 【修改点 1】增加 -P prod 参数，激活 pom.xml 中的资源分离配置
      # 这会导致 target/resources 文件夹生成，且 JAR 包体积变小
      - name: Build JAR with Maven
        run: mvn -B package spring-boot:repackage --file pom.xml -s .mvn/settings.xml -P prod

      # 【修改点 2】打包 resources 文件夹
      - name: Rename JAR and Zip Assets
        run: |
          mv "target/${{ steps.get_project_info.outputs.fat_jar_name }}" "target/${{ steps.get_project_info.outputs.release_asset_name }}"
          cd target
          
          # 打包 lib (依赖包)
          if [ -d "lib" ]; then
             echo "Packing lib..."
             find lib -exec touch -t 200001010000 {} +
             zip -r -X lib.zip lib/
          fi
          
          # [新增] 打包 resources (静态资源)
          if [ -d "resources" ]; then
             echo "Packing separated resources..."
             find resources -exec touch -t 200001010000 {} +
             zip -r -X resources.zip resources/
          fi
          cd ..

      - name: Create Release and Upload Initial Asset
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_project_info.outputs.project_version }}
          make_latest: true
          body: |
            ${{ github.event.head_commit.message }}
            
            Build: ${{ github.sha }}
          files: |
            target/${{ steps.get_project_info.outputs.release_asset_name }}
            target/lib.zip
            target/resources.zip

      - name: Generate final release-info.properties
        id: generate_properties
        run: |
          ASSETS_JSON='${{ steps.create_release.outputs.assets }}'
          JAR_NAME="${{ steps.get_project_info.outputs.release_asset_name }}"
          LIB_NAME="lib.zip"
          RES_NAME="resources.zip"  # [新增]
          RELEASE_ID='${{ steps.create_release.outputs.id }}'
          TAG_NAME="v${{ steps.get_project_info.outputs.project_version }}"
          
          ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$JAR_NAME" -r '.[] | select(.name == $name) | .id')
          LIB_ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$LIB_NAME" -r '.[] | select(.name == $name) | .id')
          RES_ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$RES_NAME" -r '.[] | select(.name == $name) | .id') # [新增]
          
          # 计算 lib 的 hash
          if [ -d "target/lib" ]; then
             LIB_SHA256=$(find target/lib -type f -name "*.jar" -exec sha256sum {} + | sort | sha256sum | awk '{print $1}')
          else
             LIB_SHA256=""
          fi
          
          # [新增] 计算 resources.zip 的 hash (用于判断是否需要更新静态资源)
          if [ -f "target/resources.zip" ]; then
             RES_SHA256=$(sha256sum target/resources.zip | awk '{print $1}')
          else
             RES_SHA256=""
          fi
          
          echo "Lib SHA256: $LIB_SHA256"
          echo "Res SHA256: $RES_SHA256"
          
          if [ -z "$RELEASE_ID" ] || [ -z "$ASSET_ID" ]; then
            echo "Error: Could not determine IDs."
            exit 1
          fi

          PROPERTIES_FILE="release-info.properties"
          echo "github.release.id=$RELEASE_ID" > $PROPERTIES_FILE
          echo "github.release.tag_name=$TAG_NAME" >> $PROPERTIES_FILE
          echo "github.asset.id=$ASSET_ID" >> $PROPERTIES_FILE
          
          if [ ! -z "$LIB_ASSET_ID" ] && [ "$LIB_ASSET_ID" != "null" ]; then
             echo "github.lib.asset.id=$LIB_ASSET_ID" >> $PROPERTIES_FILE
             echo "github.lib.sha256=$LIB_SHA256" >> $PROPERTIES_FILE
          fi
          
          # [新增] 写入资源包信息
          if [ ! -z "$RES_ASSET_ID" ] && [ "$RES_ASSET_ID" != "null" ]; then
             echo "github.resources.asset.id=$RES_ASSET_ID" >> $PROPERTIES_FILE
             echo "github.resources.sha256=$RES_SHA256" >> $PROPERTIES_FILE
          fi
          
          cat $PROPERTIES_FILE

      - name: Inject properties into JAR
        run: |
          JAR_PATH="target/${{ steps.get_project_info.outputs.release_asset_name }}"
          # 依然把元数据注入到 JAR 包中，作为版本控制的“大脑”
          jar uf "$JAR_PATH" -C . "release-info.properties"
          echo "Injected release-info.properties"

      - name: Overwrite Release Asset with final JAR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload v${{ steps.get_project_info.outputs.project_version }} "target/${{ steps.get_project_info.outputs.release_asset_name }}" --clobber
