name: Java CI/CD with Maven

on:
  push:
    branches: [ "main" ]

jobs:
  build_and_release:
    permissions:
      contents: write # å¿…é¡»æœ‰å†™çš„æƒé™æ¥æ“ä½œ release å’Œ tag
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # èŽ·å–æ‰€æœ‰åŽ†å²è®°å½•ï¼Œä»¥ä¾¿èƒ½æ‰¾åˆ°æ­£ç¡®çš„çˆ¶æäº¤
          fetch-depth: 0

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Get Project Info
        id: get_project_info
        run: |
          PROJECT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          FAT_JAR_NAME="winefox-bot.jar"
          RELEASE_ASSET_NAME="winefox-bot-${PROJECT_VERSION}.jar"
          echo "project_version=${PROJECT_VERSION}" >> $GITHUB_OUTPUT
          echo "fat_jar_name=${FAT_JAR_NAME}" >> $GITHUB_OUTPUT
          echo "release_asset_name=${RELEASE_ASSET_NAME}" >> $GITHUB_OUTPUT

      - name: Build JAR with Maven
        run: mvn -B package spring-boot:repackage --file pom.xml

      - name: Rename JAR and Zip Libs
        run: |
          mv "target/${{ steps.get_project_info.outputs.fat_jar_name }}" "target/${{ steps.get_project_info.outputs.release_asset_name }}"
          cd target
          if [ -d "lib" ]; then
             zip -r lib.zip lib/
          fi
          cd ..

      # ã€æ ¸å¿ƒä¿®æ”¹ã€‘å¼ºåˆ¶åˆ é™¤æ—§çš„ 'latest' Release å’Œ Tag
      - name: Force delete and recreate 'latest' tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. åˆ é™¤è¿œç¨‹çš„ 'latest' release (å¦‚æžœå­˜åœ¨)
          # '|| true' ç¡®ä¿åœ¨ release ä¸å­˜åœ¨æ—¶è„šæœ¬ä¸ä¼šå¤±è´¥
          gh release delete latest --yes || true
          
          # 2. åˆ é™¤è¿œç¨‹çš„ 'latest' tag
          git push origin --delete latest || true
          
          # 3. åœ¨æœ¬åœ°é‡æ–°åˆ›å»ºæŒ‡å‘å½“å‰ HEAD çš„ 'latest' tag
          git tag -f latest
          
          # 4. å°†æ–°çš„ 'latest' tag æŽ¨é€åˆ°è¿œç¨‹
          git push origin latest

      # ã€æ ¸å¿ƒä¿®æ”¹ã€‘ä½¿ç”¨æ–°çš„ 'latest' tag åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ Release
      - name: Create Release and Upload Initial Asset
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest # ä½¿ç”¨æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ–°çš„ 'latest' tag
          # `make_latest: true` ç¡®ä¿è¿™ä¸ªæ–°çš„ release è¢«æ ‡è®°ä¸º "Latest"
          make_latest: true
          body: "ðŸš€ Latest development build, updated at ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          files: |
            target/${{ steps.get_project_info.outputs.release_asset_name }}
            target/lib.zip

      - name: Generate final release-info.properties
        id: generate_properties
        run: |
          ASSETS_JSON='${{ steps.create_release.outputs.assets }}'
          JAR_NAME="${{ steps.get_project_info.outputs.release_asset_name }}"
          LIB_NAME="lib.zip"
          
          # èŽ·å– Asset ID
          ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$JAR_NAME" -r '.[] | select(.name == $name) | .id')
          LIB_ASSET_ID=$(echo "$ASSETS_JSON" | jq --arg name "$LIB_NAME" -r '.[] | select(.name == $name) | .id')
          RELEASE_ID='${{ steps.create_release.outputs.id }}'

          # ã€æ–°å¢žã€‘è®¡ç®— lib.zip çš„ SHA256 å“ˆå¸Œå€¼
          # sha256sum è¾“å‡ºæ ¼å¼ä¸º "hash  filename"ï¼Œæˆ‘ä»¬åªå–ç¬¬ä¸€éƒ¨åˆ† hash
          LIB_SHA256=$(sha256sum target/lib.zip | awk '{print $1}')
          
          if [ -z "$RELEASE_ID" ] || [ -z "$ASSET_ID" ] || [ "$ASSET_ID" == "null" ]; then
            echo "Error: Could not determine Release ID or Asset ID."
            exit 1
          fi

          echo "Final Release ID: $RELEASE_ID"
          echo "Final Asset ID (Jar): $ASSET_ID"
          echo "Final Asset ID (Lib): $LIB_ASSET_ID"
          echo "Final Lib SHA256: $LIB_SHA256"

          PROPERTIES_FILE="release-info.properties"
          echo "github.release.id=$RELEASE_ID" > $PROPERTIES_FILE
          echo "github.asset.id=$ASSET_ID" >> $PROPERTIES_FILE
          
          if [ ! -z "$LIB_ASSET_ID" ] && [ "$LIB_ASSET_ID" != "null" ]; then
             echo "github.lib.asset.id=$LIB_ASSET_ID" >> $PROPERTIES_FILE
             # ã€æ–°å¢žã€‘å†™å…¥å“ˆå¸Œå€¼åˆ°é…ç½®æ–‡ä»¶
             echo "github.lib.sha256=$LIB_SHA256" >> $PROPERTIES_FILE
          fi
          
          echo "Generated final $PROPERTIES_FILE content:"
          cat $PROPERTIES_FILE


      - name: Inject properties into JAR
        run: |
          JAR_PATH="target/${{ steps.get_project_info.outputs.release_asset_name }}"
          jar uf "$JAR_PATH" -C . "release-info.properties"
          echo "Injected final release-info.properties into $JAR_PATH"

      # ä½¿ç”¨æ³¨å…¥äº†æ­£ç¡®IDçš„JARï¼Œè¦†ç›–ä¸Šä¼ Releaseä¸­çš„æ–‡ä»¶
      - name: Overwrite Release Asset with final JAR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload latest "target/${{ steps.get_project_info.outputs.release_asset_name }}" --clobber
