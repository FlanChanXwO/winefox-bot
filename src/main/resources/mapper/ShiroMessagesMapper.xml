<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.winefoxbot.core.mapper.ShiroMessagesMapper">


    <resultMap id="ShiroUserMessageResultMap" type="com.github.winefoxbot.core.model.entity.ShiroUserMessage">
        <id property="id" column="sm_id"/>
        <result property="messageId" column="sm_message_id"/>
        <result property="time" column="sm_time"/>
        <result property="selfId" column="sm_self_id"/>
        <result property="messageType" column="sm_message_type"/>
        <result property="direction" column="sm_direction"/>
        <result property="userId" column="sm_user_id"/>
        <result property="sessionId" column="sm_ss_id"/>
        <result property="message" column="sm_message" typeHandler="com.github.winefoxbot.core.model.type.PGJsonTypeHandler"/>
        <result property="plainText" column="sm_plain_text"/>
        <result property="nickname" column="su_nickname"/>
        <result property="card" column="gm_card"/>
    </resultMap>

    <!-- 實現 selectUserMessages 方法 -->
    <select id="selectUserMessages" resultMap="ShiroUserMessageResultMap">
        SELECT
        sm.id AS sm_id,
        sm.message_id AS sm_message_id,
        sm.time AS sm_time,
        sm.self_id AS sm_self_id,
        sm.message_type AS sm_message_type,
        sm.direction AS sm_direction,
        sm.user_id AS sm_user_id,
        sm.session_id AS sm_ss_id,
        sm.message AS sm_message,
        sm.plain_text AS sm_plain_text,
        su.nickname AS su_nickname,
        gm.member_nickname AS gm_card
        FROM shiro_messages sm
        LEFT JOIN shiro_users su ON sm.user_id = su.user_id
        LEFT JOIN shiro_group_members gm ON sm.user_id = gm.user_id AND sm.group_id = gm.group_id
        WHERE  sm.session_id = #{sessionId} AND sm.message_type = #{messageType}
        ORDER BY sm.time DESC -- 按時間降序排序
        LIMIT #{limit}
    </select>
</mapper>
